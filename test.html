<html lang="en">
<head>
    <title>Faint Armory</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.4.2/handlebars.js"></script>

    <script>
        function daysAgo(firstDate) {
            const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
            const secondDate = new Date();
            return Math.round(Math.abs((firstDate - secondDate) / oneDay)) + " days ago";
        }

        $( document ).ready(function() {
            var files = [
                "2019-09-25T173000000Z.jsonl",
                "2019-09-30T173000000Z.jsonl",
                "2019-10-02T173000000Z.jsonl",
                "2019-10-09T173000000Z.jsonl",
                "2019-10-16T173000000Z.jsonl"
            ];
            $.when(
                $.get("2019-09-25T173000000Z.jsonl"),
                $.get("2019-09-30T173000000Z.jsonl"),
                $.get("2019-10-02T173000000Z.jsonl"),
                $.get("2019-10-09T173000000Z.jsonl"),
                $.get("2019-10-16T173000000Z.jsonl"),
            ).done(function() {
                const map = new Map();
                for (const data of arguments) {
                    const filePath = files.shift();
                    const { groups: { dateStr } } =/(?<dateStr>.*?)T/.exec(filePath);
                    for (const line of data[0].split("\n")) {
                        if (line !== "") {
                            const parsed = JSON.parse(line);
                            const items = parsed.items;
                            for (const item of items) {
                                const id = parsed.charName + '_' + item.name;
                                map.set(id, map.has(id) ? map.get(id) : {firstSeen: new Date(dateStr).getTime(), firstSeenAgo: daysAgo(new Date(dateStr)), itemName: item.name, charName: parsed.charName});
                                map.get(id).lastSeen = new Date(dateStr).getTime();
                                map.get(id).lastSeenAgo = daysAgo(new Date(dateStr));
                            }
                        }
                    }
                }

                const list = Array.from(map.values());

                const uniqueNames = list.map((e) => e.charName).filter(function (value, index, self) {
                    return self.indexOf(value) === index;
                });

                console.log(list);

                const chars = [
                    {
                        name: "Yvely",
                        items: list.filter((f) => f.charName === "Yvely")
                    },
                    {
                        name: "Apax",
                        items: list.filter((f) => f.charName === "Apax")
                    }
                ];
                const template = $('#datatable-template').html();
                const templateScript = Handlebars.compile(template);
                const html = templateScript({chars: chars});
                $('#content').append(html);
            });
        });

    </script>

    <script id="datatable-template" type="text/x-handlebars-template">
        {{#each chars}}
        <div class="ui compact">
            <table class="ui table small compact">
                <tbody>

                <tr>
                    <td>{{this.name}}</td>
                </tr>
                    {{#each this.items}}
                    <tr>
                        <td>{{this.itemName}}</td>
                    </tr>
                    {{/each}}

                </tbody>
            </table>
        </div>
        {{/each}}
    </script>

    <style>
        body {
            margin: 1em;
        }
    </style>
</head>
<body>

<div class="ui fluid input mini">
    <input type="text" placeholder="Search...">
</div>
<div class="ui hidden divider"></div>
<div id="content" class="ui grid">

</div>
</body>
</html>
