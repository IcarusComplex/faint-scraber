<html lang="en">
<head>
    <title>Faint Armory</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.4.2/handlebars.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>
    <script>var whTooltips = {colorLinks: true, iconizeLinks: true, renameLinks: true};</script>
    <script src="https://wow.zamimg.com/widgets/power.js"></script>

    <style>
        .uncommon {
            color: #26c426;
            font-weight: bold;
        }
        .rare {
            color: #2d2de1;
            font-weight: bold;
        }
        .epic {
            color: #8c02cd;
            font-weight: bold;
        }
        .legendary {
            color: #f0940a;
            font-weight: bold;
        }

        .truncate {
            width: 179px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .agoSmall {
            font-size: 0.7em;
        }

        body {
            padding: 1em;
            background-color: #1e1e1e;
        }
    </style>

    <script>

        let timeout = 1;
        function inputKeyupChanged(e) {
            const val = $('#input').val();
            localStorage.setItem("inputValue", val);
            clearTimeout(timeout);
            if (e.keyCode === 13) {
                renderTables();
            } else {
                timeout = setTimeout(() => renderTables(), 500);
            }
        }

        function daysAgo(firstDate) {
            const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
            const secondDate = new Date();
            return Math.round(Math.abs((firstDate - secondDate) / oneDay));
        }

        function renderTables() {
            const searchArguments = $('#input').val().split(",").map((e) => e.trim());

            var files = [
                "2019-09-25T173000000Z.jsonl",
                "2019-09-30T173000000Z.jsonl",
                "2019-10-02T173000000Z.jsonl",
                "2019-10-09T173000000Z.jsonl",
                "2019-10-16T173000000Z.jsonl",
                "2019-10-23T173000000Z.jsonl",
            ];
            const promises = [];
            files.forEach((f) => promises.push($.get(f)) );
            promises.push($.get("enchant_id_to_name.csv"));
            promises.push($.get("all_items.csv"));
            $.when.apply($, promises).done(function() {
                console.log(arguments);
                let raidItems = Papa.parse(arguments[arguments.length - 1][0], {header: true}).data;
                let enchantMap = Papa.parse(arguments[arguments.length - 2][0], {header: true}).data;

                const map = new Map();
                for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {
                    const filePath = files[fileIndex];
                    const data = arguments[fileIndex];
                    const { groups: { dateStr } } =/(?<dateStr>.*?)T/.exec(filePath);
                    for (const line of data[0].split("\n")) {
                        if (line !== "") {
                            const parsed = JSON.parse(line);
                            const items = parsed.items;
                            for (const item of items) {
                                const id = parsed.charName + '_' + item.name;
                                const enchantId = item.enchant;
                                let enchant = enchantMap.find((e) => e.id === enchantId);
                                enchant = enchant ? enchant.name : enchantId;

                                if (!map.has(id)) {
                                    const found = raidItems.find((ri) => ri.itemId === item.itemId);
                                    const init = {
                                        firstSeen: new Date(dateStr).getTime(),
                                        firstSeenAgo: daysAgo(new Date(dateStr)),
                                        itemName: item.name,
                                        itemId: item.itemId,
                                        charName: parsed.charName,
                                        location: found ? found.location : null,
                                        icon: found ? found.icon : null,
                                        rarity: found ? found.rarity : null,
                                        slot: found ? found.slot : null,
                                        type: found ? found.type : null,
                                    };
                                    map.set(id, init)
                                }

                                map.get(id).enchantId = enchantId;
                                map.get(id).enchant = enchant;
                                map.get(id).lastSeen = new Date(dateStr).getTime();
                                map.get(id).lastSeenAgo = daysAgo(new Date(dateStr));
                            }
                        }
                    }
                }

                const list = Array.from(map.values());

                const uniqueNames = list.map((e) => e.charName).filter(function (value, index, self) {
                    return self.indexOf(value) === index;
                });

                let foundInSearch = [];

                if (searchArguments.length === 1 && searchArguments[0] === "") {
                    foundInSearch = uniqueNames;
                } else {
                    uniqueNames.forEach((name) => {
                        let found = false;
                        searchArguments.forEach((d) => {
                            if (d !== "" && name.toLowerCase().indexOf(d.toLowerCase()) > -1) {
                                found = true;
                            }
                        });
                        if (found) {
                            foundInSearch.push(name);
                        }
                    });
                }

                const chars = [];
                foundInSearch.forEach((name) => {
                    const charItems = list.sort((a, b) => b.lastSeen - a.lastSeen).filter((f) => f.charName === name);
                    const lastRaidAttend = charItems[0].lastSeenAgo;

                    charItems.forEach((i) => {
                        const daysSince = i.lastSeenAgo - lastRaidAttend;
                        i.sizeByAgo = daysSince >= 7 ? "agoSmall" : "";
                    });

                    const char = {
                        name: name,
                        raidItems: charItems.filter((f) => ["MC", "ONY"].includes(f.location)),
                    };
                    if (char.raidItems.length > 0) {
                        chars.push(char);
                    }
                });

                const template = $('#datatable-template').html();
                const templateScript = Handlebars.compile(template);
                const html = templateScript({chars: chars});
                $('#content').empty();
                $('#content').append(html);
            });
        }

        $( document ).ready(function() {
            $('#input').val(localStorage.getItem("inputValue"));
            renderTables();
        });

    </script>

    <script id="datatable-template" type="text/x-handlebars-template">
        {{#each chars}}
        <div class="ui compact" style="margin-bottom: 1em;">
            <table class="ui table small compact">
                <tbody>

                <tr>
                    <td style="text-align: center; font-weight: bold;" colspan="3">{{this.name}}</td>
                </tr>
                {{#each this.raidItems}}
                <tr>
                    <td class="{{this.sizeByAgo}}">
                        <div class="truncate">
                            <a target="_blank" href="//classic.wowhead.com/item={{this.itemId}}" class="{{this.rarity}}" rel="ench={{this.enchantId}}">
                                {{this.itemName}}
                            </a>
                        </div>
                    </td>
                    <td style="width:60px; color:green; font-size:0.7em;">{{this.enchant}}</td>
                    <td style="font-size:0.7em; width:30px; text-align: center;">{{this.lastSeenAgo}}d</td>
                </tr>
                {{/each}}

                </tbody>
            </table>
        </div>
        {{/each}}
    </script>

</head>
<body>

<div class="ui fluid input mini">
    <input id="input" onkeyup="inputKeyupChanged(event)" type="text" placeholder="Search...">
</div>

<div class="ui hidden divider"></div>
<div id="content" class="ui grid">

</div>
</body>
</html>
