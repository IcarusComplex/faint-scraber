<html lang="en">
<head>
    <title>Faint Armory</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.semanticui.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.semanticui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.4.2/handlebars.js"></script>

    <script>
        function daysAgo(firstDate) {
            const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
            const secondDate = new Date();
            return Math.round(Math.abs((firstDate - secondDate) / oneDay)) + " days ago";
        }

        $( document ).ready(function() {
            var files = [
                "2019-09-25T173000000Z.jsonl",
                "2019-09-30T173000000Z.jsonl",
                "2019-10-02T173000000Z.jsonl",
                "2019-10-09T173000000Z.jsonl",
                "2019-10-16T173000000Z.jsonl"
            ];
            $.when(
                $.get("2019-09-25T173000000Z.jsonl"),
                $.get("2019-09-30T173000000Z.jsonl"),
                $.get("2019-10-02T173000000Z.jsonl"),
                $.get("2019-10-09T173000000Z.jsonl"),
                $.get("2019-10-16T173000000Z.jsonl"),
            ).done(function() {
                const map = new Map();
                for (const data of arguments) {
                    const filePath = files.shift();
                    const { groups: { dateStr } } =/(?<dateStr>.*?)T/.exec(filePath);
                    for (const line of data[0].split("\n")) {
                        if (line !== "") {
                            const parsed = JSON.parse(line);
                            const items = parsed.items;
                            for (const item of items) {
                                const id = parsed.charName + '_' + item.name;
                                map.set(id, map.has(id) ? map.get(id) : {firstSeen: new Date(dateStr).getTime(), firstSeenAgo: daysAgo(new Date(dateStr)), itemName: item.name, charName: parsed.charName});
                                map.get(id).lastSeen = new Date(dateStr).getTime();
                                map.get(id).lastSeenAgo = daysAgo(new Date(dateStr));
                            }
                        }
                    }
                }

                const template = $('#datatable-template').html();
                const templateScript = Handlebars.compile(template);
                const html = templateScript({rows: map.values()});
                $(document.body).append(html);
                $('#itemRowsTable').DataTable({
                    "orderMulti": true,
                    "pageLength": 50
                })
            });
        });

    </script>

    <script id="datatable-template" type="text/x-handlebars-template">
        <div id="table-container" class="ui" style="padding-left: 1em; padding-right: 1em;">
        <table id="itemRowsTable" class="ui celled table" style="width:100%;">
            <thead>
            <tr>
                <th>CharName</th>
                <th>ItemName</th>
                <th>First</th>
                <th>Last</th>
            </tr>
            </thead>
            <tbody>
            {{#each rows}}
            <tr>
                <td>{{this.charName}}</td>
                <td>{{this.itemName}}</td>
                <td data-order="{{this.firstSeen}}">{{this.firstSeenAgo}}</td>
                <td data-order="{{this.lastSeen}}">{{this.lastSeenAgo}}</td>
            </tr>
            {{/each}}
            </tbody>
        </table>
        </div>
    </script>
</head>
<body>

</body>
</html>
